language: python

cache: pip

dist: xenial

os:
  - linux

python:
  - &mainstream_python 3.7
  - 3.7-dev

env:
  global:
    - PIPENV_IGNORE_VIRTUALENVS=1

install:
  - &install_deps make install-deps
  - .venv/bin/pip install codecov

before_script:
  - &activate_venv source .venv/bin/activate

script:
  - make cov

after_success:
  - .venv/bin/codecov

_helpers:
  - &_mainstream_python_base
    python: *mainstream_python
  - &_reset_steps
    env: []
    before_install: skip
    install: skip
    script: skip
    after_success: []
  - &_lint_base
    stage: &pre_test_stage_name Linting and pre-test checks
    <<: *_mainstream_python_base
    <<: *_reset_steps
    install:
      - *install_deps
    before_script:
      - *activate_venv

jobs:
  include:
    - <<: *_lint_base
      name: Linting source code with isort
      script:
      - make check_isort
    - <<: *_lint_base
      name: Linting source code with black
      script:
      - make check_black
    - <<: *_lint_base
      name: Linting source code with flake8
      script:
      - make flake
    - <<: *_lint_base
      name: Linting source code with mypy
      script:
      - make mypy
    - <<: *_mainstream_python_base
      <<: *_reset_steps
      stage: deploy
      name: deploy pypi
      install:
        - *install_deps
      before_deploy:
        - *activate_venv
      deploy:
        provider: pypi
        user: linw
        password:
          secure: P1d9lTHCsJvF9htpiZINLD343TwhXQkUor3xAQJq06l/2AeQtjfZCDGHYkd+ahQfPTLs//L9uYeISaNQNi7MgmI3jq48g6YH702OrG8TrzD0a/lIaqmwVLtqkEmpTl96EBtslmtQAPJ4h/LOIk/2Hf2U/xdsWzVBkOIuXu6jmaht+GuGRH/GWvGmJMt82euLsgiUN+xhBCHVOr2vLJPw28Jsm6fsMyMzMLsQ9fnuysaGwi+QRwZxruBfmKkXLWEx3OkRz9XGVzkbtLqQabmq0QmB7cqCb1er/f5Q0hCKPqupm0p3wDPMguf/vqReZQ8Dkx5xiNG3rKKu+E4JbOxDqQhhcim5M15IIniQfVMqFl0LpKFPiI7pekeIZ2rtvUUtfcUCfTOjREc069k13fgiTsDACQsse/1sQm3PZlu21NAoaIwhw4D07x/Ar1vSwdGeZ6rHBmZzYyu8Fbo5e8xljtqV4T206Nu/9rpE0iEvzURc0bAftOCaccIO0PJON1HXFH14r2i8AJTGeWbnixbvBL4Xmok7lPRUKSAXN92EqXag0WCi0HKrMajqusH3FI2j7S+iQvWi9ad+GtjP11Qku8H/DfwyAggdtkilsFgxaeTdQIQRaM5RzPTu4GyOtT/RNKUhxmfikBTS4m1GJkB/ige9LG/32NhvCV5jSo2EP5U=
        distributions: "sdist bdist_wheel"
        skip_existing: true

stages:
  - *pre_test_stage_name
  - test
  - name: deploy
    if: ((tag =~ ^v) AND (branch = master)) OR ((tag =~ ^v) AND (tag = branch))
